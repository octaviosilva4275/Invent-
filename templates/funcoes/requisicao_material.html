<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/styles/requisicoes.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lodash/lodash.min.js"></script>
    <link rel="icon" href="/static/img/login-img/Inventlogo.png">
    <title>Requisição de Materiais</title>
</head>
<body>
    {% include '/dashboard/dashboard.html' %}

    <div class="darkmode">
        <img src="/static/img/lua.png" alt="Modo Escuro" id="lua-icon">
        <img src="/static/img/sol.png" alt="Modo Claro" class="none" id="sol-icon">
    </div>

    <section class="requisicoes">
        <form action="{{ url_for('requisicao_material') }}" method="POST">
            <div class="container-requisicoes">
                <div class="campo-requisicoes">
                    <h1 class="titulo-requisicoes">Requisição de Materiais</h1>

                    <div class="search-container">
                        <label for="Item" id="item">Item:</label>
                        <input type="text" id="search-entrada" class="search-estoque" placeholder="Pesquise o item..." onclick="toggleList('lista-entrada')" autocomplete="off">
                        <input type="hidden" id="material_id_entrada" name="material_id">
                        <ul id="lista-entrada" class="lista-estoque" style="display: none;">
                            {% if materiais %}
                                {% for material in materiais %}
                                    <li class="item-estoque"
                                        data-id="{{ material.id }}"
                                        data-descricao="{{ material.descricao }}"
                                        data-quantidade="{{ material.quantidade_disponivel }}">
                                        {{ material.descricao }} - Disponível: {{ material.quantidade_disponivel }}
                                    </li>
                                {% endfor %}
                            {% else %}
                                <li>Não há materiais disponíveis.</li>
                            {% endif %}
                        </ul>
                    </div>

                    <div class="form-requisicoes">
                        <label for="quantidade">Quantidade:</label>
                        <input placeholder="Quantidade" type="number" id="quantidade" name="quantidade">
                    </div>

                    <div class="form-requisicoes">
                        <label for="observacao">Observação:</label>
                        <textarea placeholder="Opcional" id="observacao" name="observacao" rows="4"></textarea>
                    </div>

                    <button class="btn-requisicoes">Enviar Requisição</button>
                </div>

                <div class="minhas-requisicoes">
                    <h2 class="titulo-pendente">Minhas Requisições Pendentes:</h2>

                    <table id="minhas-requisicoes-table">
                        <thead>
                            <tr>
                                <th>CÓDIGO</th>
                                <th>MATERIAL</th>
                                <th>QUANTIDADE</th>
                                <th>STATUS</th>
                                <th>ÚLTIMA ATUALIZAÇÃO</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if minhas_requisicoes %}
                                {% for requisicao in minhas_requisicoes %}
                                <tr>
                                    <td>{{ requisicao.id }}</td>
                                    <td>{{ requisicao.material }}</td>
                                    <td>{{ requisicao.quantidade }}</td>
                                    <td class="status-{{ requisicao.status | lower | replace(' ', '-') }}">
                                        {{ requisicao.status }}
                                    </td>
                                    <td>{{ requisicao.data_atualizacao or 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5">Você ainda não fez nenhuma requisição.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </form>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Página carregada, inicializando scripts...");
            
            // Ordenar itens da lista ao carregar
            try {
                sortItems('lista-entrada');
                console.log("Itens da lista ordenados com sucesso.");
            } catch (error) {
                console.error("Erro ao ordenar itens:", error);
            }
    
            // Configurar eventos
            const searchInput = document.getElementById('search-entrada');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    console.log("Texto digitado no campo de pesquisa:", searchInput.value);
                    filterItems('search-entrada', 'lista-entrada');
                });
    
                searchInput.addEventListener('blur', function () {
                    setTimeout(() => {
                        console.log("Campo perdeu o foco. Escondendo lista...");
                        document.getElementById('lista-entrada').style.display = 'none';
                    }, 200);
                });
            } else {
                console.warn("Campo de pesquisa 'search-entrada' não encontrado.");
            }
    
            const listaEntrada = document.getElementById('lista-entrada');
            if (listaEntrada) {
                listaEntrada.addEventListener('click', function (event) {
                    if (event.target.matches('.item-estoque')) {
                        const descricao = event.target.getAttribute('data-descricao');
                        const quantidade = event.target.getAttribute('data-quantidade');
                        const materialId = event.target.getAttribute('data-id');
    
                        console.log("Item selecionado:", { descricao, quantidade, materialId });
    
                        document.getElementById('search-entrada').value = `${descricao} - Disponível: ${quantidade}`;
                        document.getElementById('material_id_entrada').value = materialId;
    
                        listaEntrada.style.display = 'none';
                    }
                });
            } else {
                console.warn("Lista de entrada 'lista-entrada' não encontrada.");
            }
        });
    
        // Exibe ou oculta a lista de itens
        function toggleList(listId) {
            const list = document.getElementById(listId);
            if (list) {
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
                console.log(`Lista ${listId} agora está:`, list.style.display);
            } else {
                console.error(`Lista ${listId} não encontrada.`);
            }
        }
    
        // Filtra itens na lista com base no texto de entrada
        function filterItems(searchInputId, listId) {
            const searchText = document.getElementById(searchInputId).value.toLowerCase();
            const list = document.getElementById(listId);
            const items = list ? list.getElementsByTagName('li') : [];
    
            if (!list) {
                console.error(`Lista ${listId} não encontrada para filtrar itens.`);
                return;
            }
    
            Array.from(items).forEach(item => {
                const descricao = item.getAttribute('data-descricao').toLowerCase();
                const visible = descricao.includes(searchText);
                item.style.display = visible ? 'block' : 'none';
                console.log(`Item "${descricao}" visível: ${visible}`);
            });
        }
    
        // Ordena os itens da lista alfabeticamente
        function sortItems(listId) {
            const list = document.getElementById(listId);
            if (!list) {
                console.error(`Lista ${listId} não encontrada para ordenar itens.`);
                return;
            }
    
            const items = Array.from(list.getElementsByTagName('li'));
            items.sort((a, b) =>
                a.getAttribute('data-descricao').localeCompare(b.getAttribute('data-descricao'))
            ).forEach(item => list.appendChild(item));
    
            console.log(`Itens da lista ${listId} ordenados.`);
        }
    </script>
    
</body>
</html>
