<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface Almoxarifado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin.css) }}">
    <link rel="stylesheet" href=href="{{ url_for('static', filename='styles/medias/media-requisicoes.css) }}">
    <link rel="icon" href="/static/img/login-img/Inventlogo.png">
    <script src="{{ url_for('static', filename='darkmode js/darkmode.js') }}" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/static/javascript/darkmode.js"></script>
</head>

<body>
    {% include '/dashboard/dashboard.html' %}

    <div class="darkmode">
        <img src="/static/img/lua.png" alt="Modo Escuro" id="lua-icon">
        <img src="/static/img/sol.png" alt="Modo Claro" class="none" id="sol-icon">
    </div>

    <!-- Título adicional para mobile/tablets -->
    <div class="titulo-responsivo">Gerenciamento</div>

    <!-- Primeira sessão: Solicitação para Almoxarife -->
    <div class="gerenciamento">
        <h2>Solicitação para Almoxarife</h2>
        <!-- Verifica se existem solicitantes -->
        {% if solicitacoes %}
        <!-- Tabela de usuários -->
        <table class="tabela-solicitacao"> <!-- Adicionado o ID aqui -->
            <thead>
                <tr>
                    <th>Nome do Usuário</th>
                    <th>Código SN</th>
                    <th>Email</th>
                    <th>Id</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr>
                    <td>{{ usuario.nome }}</td>
                    <td>{{ usuario.sn }}</td>
                    <td>{{ usuario.email }}</td>
                    <td>{{ usuario.id }}</td>
                    <td>
                        <div class="btn-gerenciar">
                            <button class="excluir">EXCLUIR</button>
                            <button type="button" class="editar-usuario btn-editar" data-bs-toggle="modal"
                                data-bs-target="#editModal" data-nome="{{ usuario.nome }}"
                                data-codigo="{{ usuario.sn }}" data-email="{{ usuario.email }}">
                                Editar
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% else %}
        <!-- Mensagem exibida caso a lista esteja vazia -->
        <p class="sem-dados">Nenhuma solicitação disponível no momento.</p>
        {% endif %}
    </div>


    <!-- Container responsivo para mobile/tablets -->
    {% for solicitante in solicitacoes %}
    <div class="container-responsivo">
        <div class="linha toggle-header">
            <span class="label">Nome do Solicitante: {{ solicitante.nome }}</span>
            <span class="toggle-info">▼</span>
        </div>
        <div class="detalhes" style="display: none;">
            <div class="linha">
                <span class="label">Código SN:</span>
                <span class="valor">{{ solicitante.sn }}</span>
            </div>
            <div class="linha">
                <span class="label">Email:</span>
                <span class="valor">{{ solicitante.email }}</span>
            </div>
            <div class="linha">
                <span class="label">Id:</span>
                <span class="valor">{{ solicitante.id }}</span>
            </div>
            <div class="botoes">
                <button class="aprovado">Aprovar</button>
                <button class="excluir">Excluir</button>
            </div>
        </div>
    </div>
    {% endfor %}
    </div>

    <!-- Segunda sessão: Gerenciar Usuários -->
    <div class="gerenciamento">
        <h2>Gerenciar Usuários</h2>
        <!-- Botão para abrir o modal de cadastro -->
        <button type="button" class="cadastrar-user" data-bs-toggle="modal" data-bs-target="#cadastroModal">
            Cadastrar Novo Usuário
        </button>

        <div class="form-group">
            <label for="pesquisaUsuario">Pesquise o Usuário:</label>
            <input type="text" id="pesquisaUsuario" class="form-control" placeholder="Digite o nome do usuário">
        </div>

        <!-- Tabela apenas para desktop -->
        <table class="tabela-solicitacao" id="tabelaUsuarios">
            <thead>
                <tr>
                    <th>Nome do Usuário</th>
                    <th>Código SN</th>
                    <th>Email</th>
                    <th>Id</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr>
                    <td>{{ usuario.nome }}</td>
                    <td>{{ usuario.sn }}</td>
                    <td>{{ usuario.email }}</td>
                    <td>{{ usuario.id }}</td>
                    <td>
                        <div class="btn-gerenciar">
                            <button class="excluir">EXCLUIR</button>
                            <button type="button" class="editar-usuario btn-editar" data-bs-toggle="modal"
                                data-bs-target="#editModal" data-nome="{{ usuario.nome }}"
                                data-codigo="{{ usuario.sn }}" data-email="{{ usuario.email }}">
                                Editar
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% for usuario in usuarios %}
        <div class="container-responsivo">
            <div class="linha toggle-header">
                <span class="label">Nome do Usuário: {{ usuario.nome }}</span>
                <span class="toggle-info">▼</span>
            </div>
            <div class="detalhes" style="display: none;">
                <div class="linha">
                    <span class="label">Código SN:</span>
                    <span class="valor">{{ usuario.sn }}</span>
                </div>
                <div class="linha">
                    <span class="label">Email:</span>
                    <span class="valor">{{ usuario.email }}</span>
                </div>
                <div class="linha">
                    <span class="label">Id:</span>
                    <span class="valor">{{ usuario.id }}</span>
                </div>
                <div class="botão-usuario">
                    <button class="excluir-usuario excluir aprovado" data-user-id="{{ usuario.id }}">Excluir</button>
                    <button type="button" class="btn-editar" data-bs-toggle="modal" data-bs-target="#editModal"
                        data-nome="{{ usuario.nome }}" data-codigo="{{ usuario.sn }}" data-email="{{ usuario.email }}">
                        Editar
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}

    </div>

    <!-- Modal Bootstrap -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulário de Edição -->
                    <form id="editForm">
                        <div class="mb-3">
                            <label for="nomeUsuario" class="form-label">Nome do Usuário</label>
                            <input type="text" class="form-control" id="nomeUsuario" placeholder="Digite o nome">
                        </div>
                        <div class="mb-3">
                            <label for="codigoUsuario" class="form-label">Código SN</label>
                            <input type="text" class="form-control" id="codigoUsuario" placeholder="Digite o código">
                        </div>
                        <div class="mb-3">
                            <label for="emailUsuario" class="form-label">Email</label>
                            <input type="email" class="form-control" id="emailUsuario" placeholder="Digite o email">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="saveChanges">Salvar</button>
                </div>
            </div>
        </div>
    </div>

<!-- Modal de Cadastro -->
<div class="modal fade" id="cadastroModal" tabindex="-1" aria-labelledby="cadastroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cadastroModalLabel">Cadastrar Novo Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Formulário de Cadastro -->
                <form id="cadastroForm">
                    <div class="mb-3">
                        <label for="nomeNovoUsuario" class="form-label">Nome do Usuário</label>
                        <input type="text" class="form-control" id="nomeNovoUsuario" placeholder="Digite o nome" required>
                    </div>
                    <div class="mb-3">
                        <label for="codigoNovoUsuario" class="form-label">Código SN</label>
                        <input type="text" class="form-control" id="codigoNovoUsuario" placeholder="Digite o código" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="salvarNovoUsuario">Salvar</button>
            </div>
        </div>
    </div>
</div>


    <script>
        document.getElementById('saveChanges').addEventListener('click', function () {
            const nome = document.getElementById('nomeUsuario').value;
            const codigo = document.getElementById('codigoUsuario').value;
            const email = document.getElementById('emailUsuario').value;

            const usuarioAtivo = document.querySelector('.container-responsivo.active');
            if (usuarioAtivo) {
                usuarioAtivo.querySelector('.label').textContent = `Nome do Usuário: ${nome}`;
                usuarioAtivo.querySelector('.valor.codigo-sn').textContent = codigo;
                usuarioAtivo.querySelector('.valor.email').textContent = email;
            }

            console.log('Dados salvos:', { nome, codigo, email });

            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
        });

        document.getElementById("pesquisaUsuario").addEventListener("input", filtrarUsuarios);

        function filtrarUsuarios() {
            var input, filtro, tabela, tr, td, i, txtValue;
            input = document.getElementById("pesquisaUsuario");
            filtro = input.value.toUpperCase();
            tabela = document.getElementById("tabelaUsuarios");
            tr = tabela.getElementsByTagName("tr");

            for (i = 1; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filtro) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
    // Adicionando evento de clique no botão EXCLUIR
    document.querySelectorAll('.excluir').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.closest('tr').querySelector('td:nth-child(4)').textContent; // Obtendo o ID do usuário

            // Exibindo o alerta de confirmação
            Swal.fire({
                title: "Tem certeza?",
                text: "Você não poderá reverter isso!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sim, excluir!",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar a requisição para excluir o usuário
                    excluirUsuario(userId);
                }
            });
        });
    });

    // Função para enviar a requisição de exclusão ao servidor
    async function excluirUsuario(userId) {
        try {
            const response = await fetch('/excluir_usuario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'user_id': userId
                })
            });

            const data = await response.json();

            // Mensagem de sucesso ou erro com base na resposta
            if (data.success) {
                Swal.fire('Excluído!', 'O usuário foi excluído.', 'success').then(() => {
                    window.location.reload();  // Atualiza a página após a exclusão
                });
            } else {
                Swal.fire('Erro!', 'Ocorreu um erro ao excluir o usuário.', 'error');
            }
        } catch (error) {
            console.error('Erro ao excluir o usuário:', error);
            Swal.fire('Erro!', 'Ocorreu um erro inesperado.', 'error');
        }
    }

    // MOBILEEEEEE

      // Adicionando evento de clique no botão EXCLUIR para mobile
      document.querySelectorAll('.excluir-usuario').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.getAttribute('data-user-id'); // Obtendo o ID do usuário do botão

            // Exibindo o alerta de confirmação
            Swal.fire({
                title: "Tem certeza?",
                text: "Você não poderá reverter isso!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sim, excluir!",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar a requisição para excluir o usuário
                    excluirUsuario(userId);
                }
            });
        });
    });

    // Função para enviar a requisição de exclusão ao servidor
    async function excluirUsuario(userId) {
        try {
            const response = await fetch('/excluir_usuario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'user_id': userId
                })
            });

            const data = await response.json();

            // Mensagem de sucesso ou erro com base na resposta
            if (data.success) {
                Swal.fire('Excluído!', 'O usuário foi excluído.', 'success').then(() => {
                    window.location.reload();  // Atualiza a página após a exclusão
                });
            } else {
                Swal.fire('Erro!', 'Ocorreu um erro ao excluir o usuário.', 'error');
            }
        } catch (error) {
            console.error('Erro ao excluir o usuário:', error);
            Swal.fire('Erro!', 'Ocorreu um erro inesperado.', 'error');
        }
    }
        

        document.getElementById("pesquisaUsuario").addEventListener("input", filtrarUsuarios);

        function filtrarUsuarios() {
            var input, filtro, tabela, tr, td, i, txtValue;
            input = document.getElementById("pesquisaUsuario");
            filtro = input.value.toUpperCase();
            tabela = document.getElementById("tabelaUsuarios");
            tr = tabela.getElementsByTagName("tr");

            for (i = 1; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filtro) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        

        function filtrarUsuarios() {
    var input, filtro, tabela, tr, responsivo, containers, i, txtValue;

    // Obter o valor de pesquisa
    input = document.getElementById("pesquisaUsuario");
    filtro = input.value.toUpperCase();

    // Filtrar na tabela (Desktop)
    tabela = document.getElementById("tabelaUsuarios");
    if (tabela) {
        tr = tabela.getElementsByTagName("tr");
        for (i = 1; i < tr.length; i++) { // Ignorar cabeçalho
            const td = tr[i].getElementsByTagName("td")[0];
            if (td) {
                txtValue = td.textContent || td.innerText;
                tr[i].style.display = txtValue.toUpperCase().indexOf(filtro) > -1 ? "" : "none";
            }
        }
    }

    // Filtrar no container responsivo (Mobile)
    containers = document.querySelectorAll(".container-responsivo");
    containers.forEach(container => {
        const nomeLabel = container.querySelector(".label").textContent || "";
        if (nomeLabel.toUpperCase().indexOf(filtro) > -1) {
            container.style.display = "block";
        } else {
            container.style.display = "none";
        }
    });
}

        document.querySelectorAll('.editar-usuario').forEach(button => {
            button.addEventListener('click', function () {
                const nome = this.getAttribute('data-nome');
                const codigo = this.getAttribute('data-codigo');
                const email = this.getAttribute('data-email');

                document.getElementById('nomeUsuario').value = nome;
                document.getElementById('codigoUsuario').value = codigo;
                document.getElementById('emailUsuario').value = email;

                document.querySelectorAll('.container-responsivo').forEach(container => container.classList.remove('active'));
                this.closest('.container-responsivo').classList.add('active');
            });
        });

        document.querySelectorAll('.toggle-header').forEach(header => {
            header.addEventListener('click', function () {
                const detalhes = this.nextElementSibling;
                const isHidden = detalhes.style.display === 'none' || detalhes.style.display === '';
                detalhes.style.display = isHidden ? 'block' : 'none';
                const toggleIcon = this.querySelector('.toggle-info');
                toggleIcon.textContent = isHidden ? '▲' : '▼';
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('salvarNovoUsuario').addEventListener('click', async function () {
        const nome = document.getElementById('nomeNovoUsuario').value;
        const codigo = document.getElementById('codigoNovoUsuario').value;

        if (!nome || !codigo) {
            alert('Por favor, preencha todos os campos.');
            return;
        }

        try {
            const response = await fetch("/cadastrar_usuario", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    sn: codigo,
                    nome: nome,
                }),
            });

            const data = await response.json();

            if (data.success) {
                // Atualiza a página para exibir a mensagem flash
                window.location.reload();
            } else {
                // Atualiza a página para exibir a mensagem flash de erro
                window.location.reload();
            }
        } catch (error) {
            alert('Ocorreu um erro ao tentar cadastrar o usuário.');
            console.error(error);
        }
    });
});

    </script>
</body>

</html>